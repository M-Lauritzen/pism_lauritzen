# Note: set the environment varible ${N} to the number of processes to use for parallel
# builds and testing (overrides the default (4) used on CircleCI servers).

version: 2

jobs:
  build-gcc:
    docker:
      - image: ckhrulev/pism-ubuntu:0.1.2

    environment:
      CC: ccache mpicc
      CXX: ccache mpicxx
      CCACHE_COMPRESS: 1
      LOCAL_LIBRARIES: "~/local/hdf5;~/local/netcdf;~/local/pnetcdf;~/local/parallelio"

    steps:
      - checkout
      - restore_cache:
          keys:
            - ccache-gcc-{{ .Branch }}
      - run:
          name: Create the build directory
          command: mkdir -p build
      - run:
          name: Configure PISM
          # CMAKE_BUILD_TYPE=Debug enables pedantic compiler warnings and one or two extra
          # tests.
          #
          # CMAKE_CXX_FLAGS is set to treat all warnings as errors except for the one
          # about the "noreturn" attribute.
          #
          # We need Python bindings and extra executables for many regression tests.
          #
          # PROJ, NetCDF built with parallel I/O, and PnetCDF are optional dependencies but
          # we should build and test the code that uses them. The same applies to ICEBIN.
          #
          # CMAKE_FIND_ROOT_PATH points to HDF5 and NetCDF with support for parallel I/O.
          command: >-
            cmake -B build -S .
            -DCMAKE_SHARED_LINKER_FLAGS="-fuse-ld=lld"
            -DCMAKE_MODULE_LINKER_FLAGS="-fuse-ld=lld"
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_FIND_ROOT_PATH=${LOCAL_LIBRARIES}
            -DCMAKE_C_FLAGS="-Werror"
            -DCMAKE_CXX_FLAGS="-Werror"
            -DPism_USE_PROJ=Yes
            -DPism_USE_PARALLEL_NETCDF4=Yes
            -DPism_USE_PNETCDF=Yes
            -DPism_USE_PIO=Yes
            -DPython_ADDITIONAL_VERSIONS=3
            -DPism_BUILD_PYTHON_BINDINGS=Yes
            -DPism_BUILD_EXTRA_EXECS=Yes
            -DPism_BUILD_ICEBIN=Yes
      - run:
          name: Build PISM using GCC
          command: make --no-print-directory -C build -j ${N:-4} all
      - save_cache:
          key: ccache-gcc-{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/.ccache
      - run:
          name: Run regression tests
          command: >-
            cd build &&
            PYTHONPATH=~/project/build/site-packages:$PYTHONPATH
            ctest -j ${N:-4} --output-on-failure

  build-gcc-minimal:
    docker:
      - image: ckhrulev/pism-ubuntu:0.1.2

    environment:
      CC: ccache mpicc
      CXX: ccache mpicxx
      CCACHE_COMPRESS: 1
      LOCAL_LIBRARIES: "~/local/hdf5;~/local/netcdf;~/local/pnetcdf;~/local/parallelio"

    steps:
      - checkout
      - restore_cache:
          keys:
            - ccache-gcc-minimal-{{ .Branch }}
      - run:
          name: Create the build directory
          command: mkdir -p build
      - run:
          name: Configure PISM
          command: >-
            cmake -B build -S .
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_CXX_FLAGS="-Werror"
            -DCMAKE_FIND_ROOT_PATH=${LOCAL_LIBRARIES}
      - run:
          name: Build PISM using GCC
          command: make --no-print-directory -C build -j ${N:-4} all
      - save_cache:
          key: ccache-gcc-{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/.ccache

  build-clang:
    docker:
      - image: ckhrulev/pism-ubuntu:0.1.2

    environment:
      CCACHE_COMPRESS: 1
      CC: ccache mpicc -cc=clang
      CXX: ccache mpicxx -cxx=clang++
      LOCAL_LIBRARIES: "~/local/hdf5;~/local/netcdf;~/local/pnetcdf;~/local/parallelio"

    steps:
      - checkout
      - restore_cache:
          keys:
            - ccache-clang-{{ .Branch }}
      - run:
          name: Create the build directory
          command: mkdir -p build
      - run:
          name: Configure PISM
          command: >-
            cmake -B build -S .
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_FLAGS="-Werror"
            -DCMAKE_CXX_FLAGS="-Werror"
            -DCMAKE_FIND_ROOT_PATH=${LOCAL_LIBRARIES}
            -DCMAKE_SHARED_LINKER_FLAGS="-fuse-ld=lld"
            -DCMAKE_MODULE_LINKER_FLAGS="-fuse-ld=lld"
            -DPism_USE_PROJ=Yes
            -DPism_USE_PARALLEL_NETCDF4=Yes
            -DPism_USE_PNETCDF=Yes
            -DPism_USE_PIO=Yes
            -DPython_ADDITIONAL_VERSIONS=3
            -DPism_BUILD_PYTHON_BINDINGS=Yes
            -DPism_BUILD_EXTRA_EXECS=Yes
            -DPism_BUILD_ICEBIN=Yes
      - run:
          name: Reset ccache stats
          command: ccache -z
      - run:
          name: Build PISM using Clang
          command: make --no-print-directory -C build -j ${N:-4} all
      - run:
          name: Print ccache stats
          command: ccache -s
      - save_cache:
          key: ccache-clang-{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/.ccache
      - run:
          name: Run regression tests
          command: >-
            cd build &&
            PYTHONPATH=~/project/build/site-packages:$PYTHONPATH
            ctest -j ${N:-4} --output-on-failure

  build-clang-minimal:
    docker:
      - image: ckhrulev/pism-ubuntu:0.1.2

    environment:
      CCACHE_COMPRESS: 1
      CC: ccache mpicc -cc=clang
      CXX: ccache mpicxx -cxx=clang++
      LOCAL_LIBRARIES: "~/local/hdf5;~/local/netcdf;~/local/pnetcdf;~/local/parallelio"

    steps:
      - checkout
      - restore_cache:
          keys:
            - ccache-clang-minimal-{{ .Branch }}
      - run:
          name: Create the build directory
          command: mkdir -p build
      - run:
          name: Configure PISM
          command: >-
            cmake -B build -S .
            -DCMAKE_BUILD_TYPE=Debug
            -DCMAKE_C_FLAGS="-Werror"
            -DCMAKE_CXX_FLAGS="-Werror"
            -DCMAKE_FIND_ROOT_PATH=${LOCAL_LIBRARIES}
      - run:
          name: Reset ccache stats
          command: ccache -z
      - run:
          name: Build PISM using Clang
          command: make --no-print-directory -C build -j ${N:-4} all
      - run:
          name: Print ccache stats
          command: ccache -s
      - save_cache:
          key: ccache-clang-{{ .Branch }}-{{ .BuildNum }}
          paths:
            - ~/.ccache

  build-manual:
    docker:
      - image: ckhrulev/pism-ubuntu:0.1.2

    steps:
      - checkout
      - run:
          name: Build the manual
          command: |
            mkdir -p build
            cmake -B build -S doc/ -DCMAKE_INSTALL_PREFIX=/tmp/pism -DPism_DOC_DIR="manual"
            make -C build install
      - persist_to_workspace:
          root: /tmp/pism/manual
          paths: html

  deploy-manual:
    docker:
      - image: node:8.10.0

    steps:
      - checkout
      - attach_workspace:
          at: manual
      - run:
          name: Install and configure dependencies
          command: |
            npm install -g --silent gh-pages@2.0.1
            git config user.email "ckhroulev@alaska.edu"
            git config user.name "CI Builder (PISM manual)"
      - add_ssh_keys:
          fingerprints:
            - "0a:88:9e:95:a9:35:1b:54:f6:0e:4a:f8:3d:34:ef:30"
      - run:
          name: Deploy the manual to GitHub Pages
          command: >-
            gh-pages
            --repo git@github.com:pism/docs.git
            --dotfiles
            --message "[skip ci] Update the manual"
            --dist manual/html

workflows:
  version: 2
  build-and-test:
    jobs:
      - build-gcc
      - build-gcc-minimal
      - build-clang
      - build-clang-minimal
      - build-manual
      - deploy-manual:
          requires:
            - build-gcc
            - build-gcc-minimal
            - build-clang
            - build-clang-minimal
            - build-manual
          filters:
            branches:
              only: dev
